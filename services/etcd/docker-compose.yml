version: "3"

# define DNS entries to resolve node1 / node2 / node3 (docker host IPs)
#  optionally specify $ADV host/ip and $CLUSTER name

# to restart a cluster, generate a new DISCOVERY_TOKEN
#  DISCOVERY_TOKEN=$(basename `curl -s 'https://discovery.etcd.io/new?size=3'`)
#  export DISCOVERY_TOKEN
# use the same value on each instance
# remove the etcd_data volume, then from services dir invoke:
#  make etcd

services:
  v3:
    image: quay.io/coreos/etcd:v3.2.9
    restart: never
    hostname: ${ADV:-v3}
    volumes:
    - data:/v3.etcd
    ports:
    - ${PORT_ETCD_CLIENT:-2379}:2379
    - ${PORT_ETCD_PEER:-2380}:2380
    network_mode: host
    command: >
      sh -c "apk add --update ca-certificates &&
      /usr/local/bin/etcd \
        -name ${ADV:-v3} \
        -initial-advertise-peer-urls http://${ADV:-v3}:2380 \
        -listen-peer-urls http://0.0.0.0:2380 \
        -advertise-client-urls http://${ADV:-v3}:2379 \
        -listen-client-urls http://0.0.0.0:2379 \
        -discovery https://discovery.etcd.io/${DISCOVERY_TOKEN} \
        -initial-cluster-token ${CLUSTER:-etcd-cluster-1}"

volumes:
  data:
